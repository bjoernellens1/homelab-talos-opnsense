---
# Edge node patch - for edge worker nodes
# These nodes are woken on-demand via WoL and have taints
# Hardware: Minisforum N100 (8GB RAM)

machine:
  install:
    disk: /dev/nvme0n1 # 250GB NVMe OS Disk
    extensions:
      - image: ghcr.io/siderolabs/i915:v0.1.0
      - image: ghcr.io/siderolabs/intel-ice-firmware:20240910
      - image: ghcr.io/siderolabs/intel-ucode:20240910
      - image: ghcr.io/siderolabs/iscsi-tools:v0.1.4
      - image: ghcr.io/siderolabs/nvme-cli:v2.8.1
      - image: ghcr.io/siderolabs/realtek-firmware:20240910
      - image: ghcr.io/siderolabs/util-linux-tools:v2.39.3
    extraKernelArgs:
      - i915.enable_guc=3
      - i915.enable_fbc=1

  nodeLabels:
    node-role: edge
    availability: intermittent

  kubelet:
    extraArgs:
      rotate-certificates: true
      register-with-taints: "edge=true:NoSchedule"
    nodeIP:
      validSubnets:
        - 10.10.0.0/24  # Cluster network

  network:
    nameservers:
      - 10.10.0.1  # OPNsense with split DNS

  time:
    servers:
      - 10.10.0.1
      - time.google.com

  sysctls:
    vm.max_map_count: "262144"
    fs.inotify.max_user_watches: "524288"

  # machine.kernel is now handled via machine.install.extraKernelArgs or machine.kernel.modules

cluster:
  network:
    cni:
      name: none
