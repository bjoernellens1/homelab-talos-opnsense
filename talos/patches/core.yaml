---
# Core node patch - for control plane nodes
# These nodes are always-on and host critical services
# Hardware: Fujitsu Esprimo (64GB RAM, i5-7400T)

machine:
  install:
    disk: /dev/sda # 500GB SSD
    image: ghcr.io/siderolabs/installer:v1.11.5
    extensions:
      - image: ghcr.io/siderolabs/iscsi-tools:v1.11.5
      - image: ghcr.io/siderolabs/util-linux:v0.4.1

  nodeLabels:
    node-role: core
    availability: always-on
    storage: longhorn

  kubelet:
    extraArgs:
      rotate-certificates: true
    nodeIP:
      validSubnets:
        - 10.10.0.0/24  # Management network
    extraMounts:
      - destination: /var/lib/longhorn
        type: bind
        source: /var/lib/longhorn
        options:
          - bind
          - rshared
          - rw

  network:
    nameservers:
      - 10.10.0.1  # OPNsense with split DNS

  time:
    servers:
      - 10.10.0.1
      - time.google.com

  sysctls:
    vm.max_map_count: "262144"
    fs.inotify.max_user_watches: "524288"
    fs.inotify.max_user_instances: "512"

cluster:
  allowSchedulingOnControlPlanes: true

  apiServer:
    # Enable privileged pod security for Longhorn
    admissionControl:
      - name: PodSecurity
        configuration:
          apiVersion: pod-security.admission.config.k8s.io/v1alpha1
          defaults:
            enforce: "privileged"
            enforce-version: "latest"
            audit: "restricted"
            audit-version: "latest"
            warn: "restricted"
            warn-version: "latest"

  network:
    cni:
      name: none
